{% extends "base.html" %}

{% block navbar %}
    {% include "navbar.html" %}
{% endblock %}

{% block content %}
    <!-- Detalles de los productos -->
    <h3>Detalles de la Venta</h3>
    <table class="table">
        <thead>
            <tr>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Precio Unitario</th>
                <th>Subtotal</th>
            </tr>
        </thead>
        <tbody>
            {% for producto in productos %}
            <tr>
                <td>{{ producto.producto.nombre }}</td>
                <td>{{ producto.cantidad }}</td>
                <td>${{ producto.precio_unitario }}</td>
                <td>${{ producto.cantidad|floatformat:2|add:producto.precio_unitario|floatformat:2 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<div class="container mt-4">
    <h2>Factura para Venta {{ object.id }}</h2>
    <form method="post" id="factura-form">
        {% csrf_token %}
        {{ form.as_p }}

        <!-- Campos específicos de Factura A -->
        <div id="factura-a-campos">
            <label for="id_precio_sin_iva">Precio sin IVA:</label>
            <input type="text" id="id_precio_sin_iva" name="precio_sin_iva" value="{{ form.instance.precio_sin_iva }}" readonly>
            
            <label for="id_total_iva">IVA:</label>
            <input type="text" id="id_total_iva" name="total_iva" value="{{ form.instance.total_iva }}" readonly>
        </div>

        <!-- Este campo es común para ambos tipos de factura -->
        <label for="id_precio_con_iva">Precio con IVA:</label>
        <input type="text" id="id_precio_con_iva" name="precio_con_iva" value="{{ form.instance.precio_con_iva }}" readonly>

        <label for="id_total">Total:</label>
        <input type="text" id="id_total" name="total" value="{{ form.instance.total }}" readonly>
        
        <button type="submit" class="btn btn-success">Emitir Factura</button>
    </form>



<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tipoFacturaSelect = document.getElementById('id_tipo');
        const facturaACampos = document.getElementById('factura-a-campos');
        const precioSinIvaInput = document.getElementById('id_precio_sin_iva');
        const totalIvaInput = document.getElementById('id_total_iva');
        const precioConIvaInput = document.getElementById('id_precio_con_iva');
        const totalInput = document.getElementById('id_total');

        function calcularTotales() {
            const tipoFactura = tipoFacturaSelect.value;
            let precioConIva = parseFloat(precioConIvaInput.value) || 0;
            let totalIva = 0;

            if (tipoFactura === 'A') {
                const precioSinIva = parseFloat(precioSinIvaInput.value) || 0;
                totalIva = precioSinIva * 0.21;  // IVA 21%
                precioConIva = precioSinIva + totalIva;

                facturaACampos.style.display = 'block';
            } else if (tipoFactura === 'B') {
                facturaACampos.style.display = 'none';
            }

            totalInput.value = precioConIva.toFixed(2);
            totalIvaInput.value = totalIva.toFixed(2);
        }

        tipoFacturaSelect.addEventListener('change', calcularTotales);
        calcularTotales();
    });
</script>
{% endblock %}

{% block footer %}
{% endblock %}
